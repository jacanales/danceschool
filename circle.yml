machine:
  services:
    - docker

dependencies:
  cache_directories:
    - "~/.composer"
    - "vendor"
    - bin
    - ~/docker

  override:
    - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
    - sudo sh -c "curl -L https://github.com/docker/compose/releases/download/1.4.2/docker-compose-`uname -s`-`uname -m` > /usr/local/bin/docker-compose"
    - sudo chmod +x /usr/local/bin/docker-compose
    - ./circle-docker-cache-handler.sh load
    - docker-compose -f docker-circle.yml run app composer install --prefer-source
    - ./circle-docker-cache-handler.sh save

test:
  override:
    - docker-compose -f docker-circle.yml run app make -f /code/Makefile test