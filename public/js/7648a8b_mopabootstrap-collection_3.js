!function(b){var a=function(d,c){this.$element=b(d);this.options=b.extend({},b.fn.collection.defaults,c);var e=b(this.options.collection_id);if(typeof this.options.index==="undefined"){this.options.index={}}if(!this.options.initial_size){this.options.initial_size=e.children().size()}this.options.index[this.options.collection_id]=this.options.initial_size-1};a.prototype={constructor:a,add:function(){if(typeof this.options.max=="number"&&this.getItems().length>=this.options.max){return}this.options.index[this.options.collection_id]=this.options.index[this.options.collection_id]+1;var c=this.options.index[this.options.collection_id];if(b.isFunction(this.options.addcheckfunc)&&!this.options.addcheckfunc()){if(b.isFunction(this.options.addfailedfunc)){this.options.addfailedfunc()}return}this.addPrototype(c)},addPrototype:function(g){var j=b(this.options.collection_id);var f=j.data("prototype-name");var h=j.data("prototype-label");if(typeof f==="undefined"){f="__name__"}if(typeof h==="undefined"){h="__name__label__"}var e=new RegExp("((\"|&quot;|&amp;quot;|'|&#039;|&amp;#039;)((?!(\"|&quot;|&amp;quot;|'|&#039;|&amp;#039;|"+f+")).)+?)("+f+")","ig");var d=new RegExp("((\"|&quot;|&amp;quot;|'|&#039;|&amp;#039;)((?!(\"|&quot;|&amp;quot;|'|&#039;|&amp;#039;|"+h+")).)+?)("+h+")","ig");var i=j.attr("data-prototype").replace(/\n/g,"").replace(d,"$1"+g).replace(e,"$1"+g);var c=b(i);if(false!==b(window).triggerHandler("before-add.mopa-collection-item",[j,c,g])){j.append(c);b(window).triggerHandler("add.mopa-collection-item",[j,c,g])}},remove:function(d){var c=b(this.options.collection_id);if(typeof d=="undefined"){d=this.$element.closest(".collection-item")}if(typeof d!="undefined"){if(d instanceof jQuery){d=d.get(0)}var e=this.getIndex(d);if(e==-1){throw new Error("row not contained in collection")}if(false!==b(window).triggerHandler("before-remove.mopa-collection-item",[c,d,e])){d.parentNode.removeChild(d);b(window).triggerHandler("remove.mopa-collection-item",[c,d,e])}}},getIndex:function(f){if(f instanceof jQuery){f=f.get(0)}var e=b(this.options.collection_id);var c=e.children();for(var d=0;d<c.size();d++){if(f==c[d]){return d}}return -1},getItem:function(d){var c=this.getItems();return c[d]},getItems:function(){var c=b(this.options.collection_id);return c.children()}};b.fn.collection=function(d){var c=arguments;return this.each(function(){var i=b(this),g=i.data("collection-add-btn"),h=i.data("collection"),f=typeof d=="object"?d:{};if(g){f.collection_id=g}else{if(i.closest(".collection-items").attr("id")){f.collection_id="#"+i.closest(".collection-items").attr("id")}else{f.collection_id=this.id.length===0?false:"#"+this.id;if(!f.collection_id){throw new Error("Could not load collection id")}}}if(!h){i.data("collection",(h=new a(this,f)))}if(c.length>1){var e=c[1];var j}if(d=="add"){h.add()}if(d=="remove"){h.remove(e)}if(d=="getIndex"){j=h.getIndex(e)}if(d=="getItem"){j=h.getItem(e)}if(d=="getItems"){j=h.getItems()}if(c.length>1&&typeof c[2]=="function"){c[2].call(this,j)}})};b.fn.collection.defaults={collection_id:null,initial_size:0,addcheckfunc:false,addfailedfunc:false,max:false};b.fn.collection.Constructor=a;b(function(){b("body").on("click.collection.data-api","[data-collection-add-btn]",function(d){var c=b(d.target);if(!c.hasClass("btn")){c=c.closest(".btn")}c.collection("add");d.preventDefault()}).on("click.collection.data-api","[data-collection-remove-btn]",function(d){var c=b(d.target);if(!c.hasClass("btn")){c=c.closest(".btn")}c.collection("remove");d.preventDefault()})})}(window.jQuery);